<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Charitok Presale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Solana Wallet Adapter -->
  <script type="module">
    import {
      Connection,
      clusterApiUrl,
      LAMPORTS_PER_SOL,
      SystemProgram,
      Transaction,
      PublicKey
    } from "https://cdn.skypack.dev/@solana/web3.js";

    import {
      WalletAdapterNetwork
    } from "https://cdn.skypack.dev/@solana/wallet-adapter-base";

    import {
      WalletProvider
    } from "https://cdn.skypack.dev/@solana/wallet-adapter-react";

    import {
      getWallets
    } from "https://cdn.skypack.dev/@solana/wallet-adapter-wallets";

    import {
      WalletModalProvider,
      WalletMultiButton
    } from "https://cdn.skypack.dev/@solana/wallet-adapter-react-ui";

    const network = WalletAdapterNetwork.Mainnet; // change to Devnet if testing
    const connection = new Connection(clusterApiUrl(network));

    // Supported wallets
    const wallets = getWallets({
      network,
      wallets: ['Phantom', 'Solflare', 'Backpack', 'Ledger']
    });

    let wallet = null;
    let publicKey = null;
    const receiverWallet = new PublicKey("E4qdbjzM45hfXfqncuqwmxqU1GGJ3qs7TNuci7iSNgA5");

    window.addEventListener('load', async () => {
      // Initialize dropdown with wallets
      const select = document.getElementById("wallet-select");
      wallets.forEach((w, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = w.name;
        select.appendChild(option);
      });

      // Wallet connect
      document.getElementById("connect-btn").onclick = async () => {
        const selectedWallet = wallets[select.value];
        wallet = new selectedWallet();
        await wallet.connect();
        publicKey = wallet.publicKey;
        document.getElementById("wallet-status").innerText = `Connected: ${publicKey.toString()}`;
      };

      // Wallet disconnect
      document.getElementById("disconnect-btn").onclick = async () => {
        if (wallet) {
          await wallet.disconnect();
          publicKey = null;
          document.getElementById("wallet-status").innerText = `Disconnected`;
        }
      };

      // Send Transaction
      document.getElementById("send-btn").onclick = async () => {
        const amountSol = parseFloat(document.getElementById("amount").value);
        if (!wallet || !publicKey || !amountSol) {
          alert("Connect your wallet and enter amount first");
          return;
        }

        const transaction = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: publicKey,
            toPubkey: receiverWallet,
            lamports: amountSol * LAMPORTS_PER_SOL,
          })
        );

        try {
          const { blockhash } = await connection.getRecentBlockhash();
          transaction.recentBlockhash = blockhash;
          transaction.feePayer = publicKey;

          const signed = await wallet.signTransaction(transaction);
          const sig = await connection.sendRawTransaction(signed.serialize());
          await connection.confirmTransaction(sig);
          alert("Transaction successful! Signature: " + sig);
        } catch (err) {
          console.error(err);
          alert("Transaction failed: " + err.message);
        }
      };
    });
  </script>
</head>
<body>
  <h2>Charitok Presale Portal</h2>
  <p id="wallet-status">Wallet not connected</p>

  <select id="wallet-select">
    <option selected disabled>Select Wallet</option>
  </select>
  <button id="connect-btn">Connect Wallet</button>
  <button id="disconnect-btn">Disconnect</button>

  <br><br>
  <label for="amount">Amount in SOL:</label>
  <input id="amount" type="number" min="0.01" step="0.01" placeholder="e.g. 0.5">
  <button id="send-btn">Send Transaction</button>
</body>
</html>
